<%- layout("layouts/boilerplate") -%>
<% include ../partials/navbar-alt.ejs %>

<form class="m-5" action="/sermons" method="POST">
    <h2>Post an event</h2>
    <br>
    <div class="form-group">
        <label for="title">Event Title</label>
        <input type="text" class="form-control" placeholder="Enter Event Title" id="title" name="title">
    </div>

    <div class="form-row">
        <div class="form-group col-md-6">
            <label for="dayOfWeek">Choose day of week</label>
            <select id="dayOfWeek" class="form-control">
                <option selected>Choose...</option>
              <option>Sunday</option>
              <option>Monday</option>
              <option>Tuesday</option>
              <option>Wednesday</option>
              <option>Thursday</option>
              <option>Friday</option>
              <option>Saturday</option>
            </select>
        </div>

        <div class="form-group col-md-6">
            <label for="time">Choose a time</label>
            <input id="time" class="form-control" placeholder="Choose Time" name="time">
        </div>
    </div>

    <!-- ACTIVITIES -->
    <div id="act-cont">

        <div class="form-row act-row">
            <div class="form-group col-md-6">
                <label>Activity # 1</label>
                <input id="activity" class="form-control" placeholder="Enter Activity Name" name="activity[]">
            </div>
    
            <div class="form-group col-md-6">
                <label>&nbsp;</label>
                <input class="scheduleTime form-control" class="form-control" placeholder="Select Time" name="act-time[]">
            </div>
            
            <button type="button" class="ml-auto mr-1 btn btn-danger deleteBtn">DELETE</button>
        </div>
    
    </div>
    

    <button type="button" id="addAct" class="btn btn-primary">Add new activity</button>
    <br><br>

    <!-- MESSAGE -->
    <div class="form-group">
        <label for="msg">Message</label>
        <textarea class="form-control" placeholder="Enter Event Message" id="msg" name="msg"></textarea>
    </div>

    <!-- LINK -->
    <div class="form-group">
        <label for="link">Link</label>
        <input class="form-control" placeholder="Enter Event Link" id="link" name="link">
    </div>

    <!-- LOCATION -->
    <div id="loc-cont">

        <div class="form-group loc">
            <label>Location # 1</label>
            <input class="form-control" placeholder="Enter Location" name="location[]">
            <br>
            <div class="d-flex">
                <button type="button" class="ml-auto mr-1 btn btn-danger deleteLoc">DELETE</button>
            </div>
        </div>     

    </div>

    <button type="button" id="addLoc" class="btn btn-primary">Add new location</button>
    <br><br>

    <br>
    <div class="form-group">
        <button type="submit" class="btn btn-success">SUBMIT</button>
        <a type="button" href="/sermons" class="btn btn-secondary">CANCEL</a>
    </div>
</form>

<script>
    $('[data-toggle="datepicker"]').datepicker();
    $('#time').timepicker();

    $('.scheduleTime').timepicker();

    // on click, add new activity
    let actNo = 1;
    $('#addAct').on("click", function(){
        $("#act-cont").append(
            `
            <div class="form-row act-row">
                <div class="form-group col-md-6">
                    <label>Activity # ${++actNo}</label>
                    <input class="form-control" placeholder="Enter Activity Name" name="activity[]">
                </div>
        
                <div class="form-group col-md-6">
                    <label>&nbsp;</label>
                    <input class="scheduleTime form-control" class="form-control" placeholder="Select Time" name="act-time[]">
                </div>

                <button type="button" class="ml-auto mr-1 btn btn-danger deleteBtn">DELETE</button>
            </div>
            `
        );

        $('.scheduleTime').timepicker();

        // on click delete
        $(".deleteBtn").each(function(){
            $(this).on("click", function(){
                let index = $(".deleteBtn").index( $(this) );
                $(".act-row").eq(index).remove(); // delete act row
                --actNo; // decrement activity number
            });
        });
    });

    // on click add new location
    let locNo = 1;
    $("#addLoc").on("click", function(){
        $("#loc-cont").append(
            `
            <div class="form-group loc">
                <label>Location # ${++locNo}</label>
                <input class="form-control" placeholder="Enter Location" name="location[]">
                <br>
                <div class="d-flex">
                    <button type="button" class="ml-auto mr-1 btn btn-danger deleteLoc">DELETE</button>
                </div>
            </div>  
            `
        );
    });

    // on click delete
    $(".deleteBtn").each(function(){
        $(this).on("click", function(){
            let index = $(".deleteBtn").index( $(this) );
            $(".act-row").eq(index).remove(); // delete act row
            --actNo; // decrement activity number
        });
    });


    // delete locations
    $("#loc-cont").on("click", ".deleteLoc", function(){
        $(this).parent().parent().remove();
        --locNo;
    });


    // on submit configure data
    $("form").submit(function(event){
        event.preventDefault();

        let formData = $('form').serializeArray();
        let dayOfWeek = $("#dayOfWeek").val() !== "Choose..." ? $("#dayOfWeek").val() : null;

        // configure schedule
        let activities = formData.filter(data => data.name === "activity[]");
        let actTimes = formData.filter(data => data.name === "act-time[]");

        let schedule = [];
        for(let i = 0; i < activities.length; ++i){
            let activity = {
                activity: activities[i].value,
                time: actTimes[i].value,
            }

            schedule.push(activity);
        }

        // configure location
        let locationVals = formData.filter(data => data.name === "location[]");

        let location = [];
        for(let i = 0; i < locationVals.length; ++i){
            location.push(locationVals[i].value);
        }

        // assemble submission
        let submission = {
            title: formData.find(data => data.name === "title").value,
            dayOfWeek: dayOfWeek,
            msg: formData.find(data => data.name === "msg").value,
            link: formData.find(data => data.name === "link").value,
            time: formData.find(data => data.name === "time").value,
            location: location,
            schedule: schedule,
        }

        console.log(submission);

        $.post("/events", { data: JSON.stringify(submission) }, 
        
            // on success
            function(data){
                window.location.href = "/events";
            });
    });
</script>